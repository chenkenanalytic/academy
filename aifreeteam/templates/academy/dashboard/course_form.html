{% extends 'academy/dashboard/base.html' %}

{% block extra_head %}
{{ form.media }}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        {% if course %}編輯課程：{{ course.title }}{% else %}建立新課程{% endif %}
    </h2>
    <a href="{% url 'dashboard_home' %}" class="btn btn-outline-secondary">
        <i class="fa-solid fa-arrow-left"></i> 返回列表
    </a>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <form method="post">
            {% csrf_token %}

            <div class="row g-3">
                <div class="col-12">
                    <div class="mb-3 p-3 bg-light rounded border">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="fw-bold m-0">{{ form.cate.label }}</label>
                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                                data-bs-target="#addCategoryModal">
                                <i class="fa-solid fa-plus"></i> 快速新增主題
                            </button>
                        </div>
                        <div class="d-flex flex-wrap gap-3" id="category-checkboxes">
                            {% for checkbox in form.cate %}
                            <div class="form-check">
                                {{ checkbox.tag }}
                                <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                                    {{ checkbox.choice_label }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        {{ form.cate.errors }}
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="mb-3">
                        {{ form.title.label_tag }}
                        {{ form.title }}
                        {{ form.title.errors }}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        {{ form.slug.label_tag }}
                        {{ form.slug }}
                        {{ form.slug.errors }}
                    </div>
                </div>

                <div class="col-12">
                    <div class="mb-3">
                        {{ form.subtitle.label_tag }}
                        {{ form.subtitle }}
                    </div>
                </div>

                <div class="col-12">
                    <div class="mb-3">
                        {{ form.description.label_tag }}
                        {{ form.description }}
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.instructor.label_tag }}
                        {{ form.instructor }}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.img_link.label_tag }}
                        {{ form.img_link }}
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="mb-3">
                        {{ form.price.label_tag }}
                        {{ form.price }}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        {{ form.duration_hours.label_tag }}
                        {{ form.duration_hours }}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        {{ form.level.label_tag }}
                        {{ form.level }}
                    </div>
                </div>

                <div class="col-12">
                    <div class="form-check form-switch">
                        {{ form.is_published }}
                        <label class="form-check-label" for="{{ form.is_published.id_for_label }}">是否發布 (公開顯示)</label>
                    </div>
                    <div class="form-check form-switch">
                        {{ form.certificate_available }}
                        <label class="form-check-label"
                            for="{{ form.certificate_available.id_for_label }}">提供完課證書</label>
                    </div>
                </div>
            </div>

            <hr class="my-4">
            <div class="text-end">
                <button type="submit" class="btn btn-primary px-4">儲存課程</button>
            </div>
        </form>
    </div>
</div>

<!-- Quick Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">快速新增主題</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">主題名稱</label>
                    <input type="text" id="newCatName" class="form-control" placeholder="例如：AI 繪圖實戰">
                </div>
                <div class="mb-3">
                    <label class="form-label">網址代稱 (Slug)</label>
                    <input type="text" id="newCatSlug" class="form-control" placeholder="例如：ai-art">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" id="btnSaveCategory" class="btn btn-primary">儲存並取用</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('btnSaveCategory').addEventListener('click', function () {
        const name = document.getElementById('newCatName').value;
        const slug = document.getElementById('newCatSlug').value;

        if (!name || !slug) {
            Swal.fire('錯誤', '名稱與網址代稱不可為空', 'error');
            return;
        }

        fetch('{% url "api_category_create" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ name: name, slug: slug })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add new checkbox to the list
                    const container = document.getElementById('category-checkboxes');
                    const div = document.createElement('div');
                    div.className = 'form-check';

                    // Construct the checkbox HTML manually to match Django output
                    const checkboxId = 'id_cate_' + (container.children.length + 100); // Random high index to avoid collision
                    div.innerHTML = `
                    <input type="checkbox" name="cate" value="${data.id}" class="form-check-input" id="${checkboxId}" checked>
                    <label class="form-check-label" for="${checkboxId}">
                        ${data.name}
                    </label>
                `;
                    container.appendChild(div);

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addCategoryModal'));
                    modal.hide();

                    // Clear fields
                    document.getElementById('newCatName').value = '';
                    document.getElementById('newCatSlug').value = '';

                    // Show success
                    Toast.fire({
                        icon: 'success',
                        title: '主題新增成功'
                    });
                } else {
                    Swal.fire('錯誤', data.error || '新增失敗', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('錯誤', '網路請求失敗', 'error');
            });
    });
</script>
{% endblock %}